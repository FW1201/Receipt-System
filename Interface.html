<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      min-height: 100vh;
    }
    .card { 
      border: none; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      backdrop-filter: blur(10px);
      border-radius: 16px;
    }
    .signature-pad { 
      border: 2px solid #e9ecef; 
      border-radius: 8px; 
      width: 100%; 
      height: 200px; 
      background: #fff; 
      cursor: crosshair;
      transition: border-color 0.3s ease;
    }
    .signature-pad:hover { border-color: #0d6efd; }
    canvas { width: 100%; height: 100%; }
    .file-upload { 
      border: 2px dashed #ced4da; 
      border-radius: 8px; 
      padding: 30px; 
      text-align: center; 
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    .file-upload:hover { 
      border-color: #0d6efd; 
      background-color: #e3f2fd; 
      transform: translateY(-2px);
    }
    .btn { border-radius: 8px; font-weight: 500; }
    .form-control, .form-select { border-radius: 8px; }
    .alert { border-radius: 12px; }
    .table { border-radius: 12px; overflow: hidden; }
    .status-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
  </style>
</head>
<body>

<? if (typeof mode === 'undefined') { ?>
  <!-- ç®¡ç†å“¡ç™»å…¥æª¢æŸ¥ -->
  <div id="login-check" class="container">
    <div class="row vh-100 justify-content-center align-items-center">
      <div class="col-md-6 col-lg-4">
        <div class="card p-4 bg-white bg-opacity-95">
          <div class="card-body text-center">
            <div class="mb-4">
              <i class="bi bi-shield-check text-primary" style="font-size: 3rem;"></i>
            </div>
            <h3 class="mb-4 text-primary">é›»å­é ˜æ“šç®¡ç†å¾Œå°</h3>
            <div class="alert alert-info border-0">
              <small><i class="bi bi-info-circle"></i> åƒ…é™ç³»çµ±éƒ¨ç½²è€…ç™»å…¥<br><strong id="admin-email" class="text-primary">è¼‰å…¥ä¸­...</strong></small>
            </div>
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p class="text-muted">æ­£åœ¨é©—è­‰ç®¡ç†å“¡èº«ä»½...</p>
            <div id="error-message" class="alert alert-danger mt-3 d-none border-0"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†å“¡å„€è¡¨æ¿ -->
  <div id="admin-dashboard" class="container-fluid my-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="text-white mb-1"><i class="bi bi-speedometer2"></i> ç®¡ç†å“¡å„€è¡¨æ¿</h2>
        <small class="text-white-50">é›»å­é ˜æ“šç³»çµ±ç®¡ç†ä¸­å¿ƒ</small>
      </div>
      <div class="text-end">
        <small class="text-white-50 d-block">ç•¶å‰ç®¡ç†å“¡</small>
        <small class="text-white"><i class="bi bi-person-check"></i> <span id="current-user"></span></small>
      </div>
    </div>

    <!-- ç™¼é€é‚€è«‹å¡ç‰‡ -->
    <div class="card mb-4 bg-white bg-opacity-95">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-send-fill"></i> ç™¼é€é ˜æ“šé‚€è«‹</h5>
      </div>
      <div class="card-body">
        <form id="invitationForm">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-bold">é ˜æ“šæŠ¬é ­ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="receiptHeader" placeholder="ä¾‹å¦‚ï¼šè²¡åœ˜æ³•äººæŸæŸåŸºé‡‘æœƒã€æŸæŸè‚¡ä»½æœ‰é™å…¬å¸" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">é ˜æ¬¾äººå§“å <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="recipientName" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="recipientEmail" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">æ’¥æ¬¾/é‚€ç´„å–®ä½ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="payerUnit" placeholder="ä¾‹ï¼šè²¡åœ˜æ³•äººæŸæŸåŸºé‡‘æœƒ" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">äº‹ä»¶åç¨± <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="eventName" placeholder="ä¾‹ï¼šè¬›åº§æ¼”è¬›ã€æ´»å‹•å”åŠ©" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">äº‹ç”± <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="eventReason" placeholder="ä¾‹ï¼šå°ˆé¡Œæ¼”è¬›è²»ã€æ´»å‹•å”åŠ©è²»" required>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">é‡‘é¡ (æ–°å°å¹£) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="amount" min="1" required>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">æ™‚æ•¸ <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="hours" step="0.5" min="0.5" required>
            </div>
          </div>
          <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-send"></i> ç™¼é€é‚€è«‹
            </button>
            <div id="invite-loading" class="d-inline-block ms-3 d-none">
              <div class="spinner-border spinner-border-sm text-primary"></div>
              <span class="ms-2 text-muted">ç™¼é€ä¸­...</span>
            </div>
          </div>
        </form>
        <div id="invite-message" class="mt-3"></div>
      </div>
    </div>

    <!-- ç´€éŒ„ç®¡ç†å¡ç‰‡ -->
    <div class="card bg-white bg-opacity-95">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-table"></i> å¡«å¯«ç´€éŒ„ç®¡ç†</h5>
        <button class="btn btn-light btn-sm" id="refresh-btn">
          <i class="bi bi-arrow-clockwise"></i> é‡æ–°æ•´ç†
        </button>
      </div>
      <div class="card-body">
        <div id="records-loading" class="text-center py-5">
          <div class="spinner-border text-primary"></div>
          <p class="mt-3 text-muted">è¼‰å…¥ç´€éŒ„ä¸­...</p>
        </div>
        <div id="records-table-container" class="table-responsive d-none">
          <table class="table table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>ç‹€æ…‹</th><th>æŠ¬é ­</th><th>é ˜æ¬¾äºº</th><th>Email</th><th>é‡‘é¡</th><th>æ™‚æ•¸</th><th>äº‹ä»¶</th><th>æäº¤æ™‚é–“</th><th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="records-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      loadAdminInfo();
      checkLogin();
    });

    function loadAdminInfo() {
      google.script.run
        .withSuccessHandler(adminEmail => {
          document.getElementById('admin-email').textContent = adminEmail || 'ç³»çµ±ç®¡ç†å“¡';
        })
        .withFailureHandler(() => {
          document.getElementById('admin-email').textContent = 'ç³»çµ±ç®¡ç†å“¡';
        })
        .getAdminEmail();
    }

    let loginRetryCount = 0;
    const maxRetries = 3;
    
    function checkLogin() {
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.success) {
            document.getElementById('login-check').classList.add('d-none');
            document.getElementById('admin-dashboard').classList.remove('d-none');
            document.getElementById('current-user').textContent = response.user;
            initAdminFunctions();
          } else {
            const message = response ? response.message : 'æœªçŸ¥éŒ¯èª¤';
            showLoginError('é©—è­‰å¤±æ•—', message);
          }
        })
        .withFailureHandler(error => {
          loginRetryCount++;
          if (loginRetryCount < maxRetries) {
            setTimeout(() => {
              document.querySelector('#login-check p').textContent = `é©—è­‰å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦... (${loginRetryCount}/${maxRetries})`;
              checkLogin();
            }, 2000);
          } else {
            showLoginError('é©—è­‰å¤±æ•—', error.message || 'ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        })
        .verifyAdminLogin();
    }
    
    function showLoginError(title, message) {
      document.querySelector('#login-check .spinner-border').classList.add('d-none');
      document.querySelector('#login-check p').textContent = title;
      document.getElementById('error-message').innerHTML = `
        <strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong>${message}<br>
        <small class="mt-2 d-block">
          <strong>è§£æ±ºæ–¹æ³•ï¼š</strong><br>
          1. ç¢ºèª Web App éƒ¨ç½²è¨­å®šç‚ºã€ŒåŸ·è¡Œèº«ä»½ï¼šæˆ‘ã€<br>
          2. åœ¨è©¦ç®—è¡¨ä¸­åŸ·è¡Œã€Œé›»å­é ˜æ“šç³»çµ±ã€â†’ã€ŒğŸš€ é¦–æ¬¡è¨­å®šã€<br>
          3. ä½¿ç”¨éƒ¨ç½²è€… Google å¸³è™Ÿç™»å…¥<br>
          4. å¦‚å•é¡ŒæŒçºŒï¼Œè«‹é‡æ–°éƒ¨ç½² Web App
        </small>
      `;
      document.getElementById('error-message').classList.remove('d-none');
    }

    function initAdminFunctions() {
      loadRecords();
      document.getElementById('refresh-btn').addEventListener('click', loadRecords);
      
      document.getElementById('invitationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const loading = document.getElementById('invite-loading');
        const message = document.getElementById('invite-message');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        loading.classList.remove('d-none');
        submitBtn.disabled = true;
        message.innerHTML = '';
        
        google.script.run
          .withSuccessHandler(response => {
            loading.classList.add('d-none');
            submitBtn.disabled = false;
            if (response.includes('å·²ç™¼é€')) {
              message.innerHTML = `<div class="alert alert-success border-0"><i class="bi bi-check-circle"></i> ${response}</div>`;
              document.getElementById('invitationForm').reset();
              loadRecords();
            } else {
              message.innerHTML = `<div class="alert alert-warning border-0"><i class="bi bi-exclamation-triangle"></i> ${response}</div>`;
            }
          })
          .withFailureHandler(err => {
            loading.classList.add('d-none');
            submitBtn.disabled = false;
            message.innerHTML = `<div class="alert alert-danger border-0"><i class="bi bi-x-circle"></i> ç™¼é€å¤±æ•—ï¼š${err.message}</div>`;
          })
          .sendInvitation({
            receiptHeader: document.getElementById('receiptHeader').value,
            recipientName: document.getElementById('recipientName').value,
            recipientEmail: document.getElementById('recipientEmail').value,
            payerUnit: document.getElementById('payerUnit').value,
            eventName: document.getElementById('eventName').value,
            eventReason: document.getElementById('eventReason').value,
            amount: document.getElementById('amount').value,
            hours: document.getElementById('hours').value
          });
      });
    }
  </script>

<? } else if (mode === 'form') { ?>
  <!-- é ˜æ¬¾äººå¡«å¯«ä»‹é¢ -->
  <div class="container my-4">
    <div class="card mx-auto bg-white bg-opacity-95" style="max-width: 800px;">
      <div class="card-header bg-primary text-white text-center">
        <h2 class="mb-0"><i class="bi bi-file-earmark-text"></i> é›»å­é ˜æ“šå¡«å ±</h2>
      </div>
      <div class="card-body p-4">
        <div class="alert alert-info border-0 mb-4">
          <h6 class="alert-heading"><i class="bi bi-info-circle"></i> é ˜æ“šè³‡è¨Š</h6>
          <hr>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>é ˜æ“šæŠ¬é ­ï¼š</strong><?= data.receiptHeader ?></p>
              <p class="mb-1"><strong>é ˜æ¬¾äººï¼š</strong><?= data.recipientName ?></p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>é‡‘é¡ï¼š</strong>æ–°å°å¹£ <?= data.amount ?> å…ƒæ•´</p>
              <p class="mb-0"><strong>æ™‚æ•¸ï¼š</strong><?= data.hours ?> å°æ™‚</p>
            </div>
          </div>
        </div>
    
        <form id="receiptForm">
          <input type="hidden" id="uniqueId" value="<?= data.uniqueId ?>">
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">èº«åˆ†è­‰å­—è™Ÿ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="idNumber" placeholder="ä¾‹ï¼šA123456789" maxlength="10" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">è¯çµ¡é›»è©± <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="phone" placeholder="ä¾‹ï¼š0912345678" required>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">æˆ¶ç±åœ°å€ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="address" placeholder="è«‹å¡«å¯«å®Œæ•´æˆ¶ç±åœ°å€" required>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">æœå‹™å–®ä½ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="serviceUnit" placeholder="ä¾‹ï¼šæŸæŸå…¬å¸ã€æŸæŸå­¸æ ¡ã€è‡ªç”±å·¥ä½œè€…" required>
            </div>
          </div>

          <hr class="my-4">
          <h5 class="text-primary mb-3"><i class="bi bi-bank"></i> éŠ€è¡Œè³‡è¨Š</h5>
          
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label class="form-label fw-bold">éŠ€è¡Œä»£è™Ÿ <span class="text-danger">*</span></label>
              <select class="form-select" id="bankCode" required>
                <option value="">è«‹é¸æ“‡éŠ€è¡Œ</option>
                <option value="004">004 - è‡ºç£éŠ€è¡Œ</option>
                <option value="005">005 - å°ç£åœŸåœ°éŠ€è¡Œ</option>
                <option value="006">006 - åˆä½œé‡‘åº«éŠ€è¡Œ</option>
                <option value="007">007 - ç¬¬ä¸€å•†æ¥­éŠ€è¡Œ</option>
                <option value="008">008 - è¯å—å•†æ¥­éŠ€è¡Œ</option>
                <option value="009">009 - å½°åŒ–å•†æ¥­éŠ€è¡Œ</option>
                <option value="012">012 - å°åŒ—å¯Œé‚¦éŠ€è¡Œ</option>
                <option value="013">013 - åœ‹æ³°ä¸–è¯å•†æ¥­éŠ€è¡Œ</option>
                <option value="017">017 - å…†è±åœ‹éš›å•†æ¥­éŠ€è¡Œ</option>
                <option value="050">050 - å°ç£ä¸­å°ä¼æ¥­éŠ€è¡Œ</option>
                <option value="700">700 - ä¸­è¯éƒµæ”¿</option>
                <option value="803">803 - è¯é‚¦å•†æ¥­éŠ€è¡Œ</option>
                <option value="805">805 - é æ±å•†æ¥­éŠ€è¡Œ</option>
                <option value="806">806 - å…ƒå¤§éŠ€è¡Œ</option>
                <option value="807">807 - æ°¸è±éŠ€è¡Œ</option>
                <option value="808">808 - ç‰å±±å•†æ¥­éŠ€è¡Œ</option>
                <option value="812">812 - å°æ–°åœ‹éš›å•†æ¥­éŠ€è¡Œ</option>
                <option value="822">822 - ä¸­åœ‹ä¿¡è¨—å•†æ¥­éŠ€è¡Œ</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">åˆ†è¡Œä»£è™Ÿ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="branchCode" placeholder="ä¾‹ï¼š0001" maxlength="4" required>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">å¸³è™Ÿ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="accountNumber" placeholder="è«‹è¼¸å…¥å®Œæ•´å¸³è™Ÿ" required>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">å­˜æ‘ºå½±æœ¬ä¸Šå‚³</label>
            <div class="file-upload" id="bankbook-upload">
              <i class="bi bi-cloud-upload text-primary" style="font-size: 2rem;"></i>
              <p class="mb-2 mt-2"><strong>é»æ“Šä¸Šå‚³å­˜æ‘ºå½±æœ¬</strong></p>
              <small class="text-muted">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 5MB</small>
              <input type="file" id="bankbook-file" accept="image/*" style="display:none;">
            </div>
            <div id="bankbook-preview" class="mt-3 d-none">
              <div class="d-flex align-items-center">
                <img id="bankbook-img" style="max-width:150px;max-height:100px;" class="img-thumbnail me-3">
                <div>
                  <p class="mb-1 text-success"><i class="bi bi-check-circle"></i> æª”æ¡ˆä¸Šå‚³æˆåŠŸ</p>
                  <button type="button" class="btn btn-outline-danger btn-sm" id="remove-bankbook">
                    <i class="bi bi-trash"></i> ç§»é™¤æª”æ¡ˆ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">é›»å­ç°½å <span class="text-danger">*</span></label>
            <p class="text-muted small mb-2">è«‹åœ¨ä¸‹æ–¹å€åŸŸå…§ç°½åï¼Œæ”¯æ´æ»‘é¼ æˆ–è§¸æ§æ“ä½œ</p>
            <div class="signature-pad">
              <canvas id="signature-pad"></canvas>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="clear-signature">
              <i class="bi bi-arrow-clockwise"></i> æ¸…é™¤é‡ç°½
            </button>
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-check-circle"></i> æäº¤è³‡æ–™
            </button>
          </div>
        </form>
        
        <div id="loading" class="text-center mt-4 d-none">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2 text-muted">è³‡æ–™è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        <div id="message" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script>
    const canvas = document.getElementById("signature-pad");
    const signaturePad = new SignaturePad(canvas, { 
      backgroundColor: 'white',
      penColor: 'black',
      minWidth: 1,
      maxWidth: 3
    });
    let bankbookImage = null;
    
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    
    document.getElementById("clear-signature").addEventListener("click", () => {
      signaturePad.clear();
    });
    
    // æª”æ¡ˆä¸Šå‚³è™•ç†
    document.getElementById("bankbook-upload").addEventListener("click", () => {
      document.getElementById("bankbook-file").click();
    });
    
    document.getElementById("bankbook-file").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          bankbookImage = e.target.result;
          document.getElementById("bankbook-img").src = bankbookImage;
          document.getElementById("bankbook-preview").classList.remove("d-none");
        };
        reader.readAsDataURL(file);
      }
    });
    
    document.getElementById("remove-bankbook").addEventListener("click", () => {
      bankbookImage = null;
      document.getElementById("bankbook-preview").classList.add("d-none");
      document.getElementById("bankbook-file").value = '';
    });
    
    document.getElementById("receiptForm").addEventListener("submit", function(e) {
      e.preventDefault();
      
      if (signaturePad.isEmpty()) {
        alert("è«‹æä¾›é›»å­ç°½å");
        return;
      }
      
      document.getElementById("loading").classList.remove("d-none");
      document.querySelector('button[type="submit"]').disabled = true;

      google.script.run
        .withSuccessHandler(response => {
          document.getElementById("loading").classList.add("d-none");
          const msgDiv = document.getElementById("message");
          
          if (response.includes("æˆåŠŸ")) {
            msgDiv.innerHTML = `<div class="alert alert-success border-0"><i class="bi bi-check-circle"></i> ${response}</div>`;
            document.getElementById("receiptForm").style.display = 'none';
          } else {
            msgDiv.innerHTML = `<div class="alert alert-danger border-0"><i class="bi bi-x-circle"></i> ${response}</div>`;
            document.querySelector('button[type="submit"]').disabled = false;
          }
        })
        .withFailureHandler(error => {
          document.getElementById("loading").classList.add("d-none");
          document.getElementById("message").innerHTML = `<div class="alert alert-danger border-0"><i class="bi bi-x-circle"></i> ç³»çµ±éŒ¯èª¤ï¼š${error.message}</div>`;
          document.querySelector('button[type="submit"]').disabled = false;
        })
        .processFormSubmission({
          uniqueId: document.getElementById("uniqueId").value,
          idNumber: document.getElementById("idNumber").value,
          address: document.getElementById("address").value,
          phone: document.getElementById("phone").value,
          serviceUnit: document.getElementById("serviceUnit").value,
          bankCode: document.getElementById("bankCode").value,
          branchCode: document.getElementById("branchCode").value,
          accountNumber: document.getElementById("accountNumber").value,
          bankbookImage: bankbookImage,
          signature: signaturePad.toDataURL("image/png")
        });
    });
  </script>

<? } ?>

<script>
function getStatusBadge(status) {
  const badges = { 
    'Pending': 'bg-secondary', 
    'Sent': 'bg-info', 
    'Submitted': 'bg-success', 
    'Error': 'bg-danger' 
  };
  const labels = {
    'Pending': 'å¾…è™•ç†',
    'Sent': 'å·²ç™¼é€',
    'Submitted': 'å·²æäº¤',
    'Error': 'éŒ¯èª¤'
  };
  return `<span class="badge ${badges[status] || 'bg-light text-dark'} status-badge">${labels[status] || status}</span>`;
}

function loadRecords() {
  document.getElementById('records-loading').classList.remove('d-none');
  document.getElementById('records-table-container').classList.add('d-none');
  
  google.script.run
    .withSuccessHandler(records => {
      const tbody = document.getElementById('records-tbody');
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">æš«ç„¡ç´€éŒ„</td></tr>';
      } else {
        tbody.innerHTML = records.map(rec => 
          `<tr>
            <td>${getStatusBadge(rec.status)}</td>
            <td><small>${rec.receipt_header || 'N/A'}</small></td>
            <td><strong>${rec.recipient_name}</strong></td>
            <td><small>${rec.recipient_email}</small></td>
            <td><span class="badge bg-light text-dark">$${rec.amount}</span></td>
            <td><span class="badge bg-light text-dark">${rec.hours}h</span></td>
            <td><small>${rec.event_name}</small></td>
            <td><small>${rec.submission_timestamp || 'æœªæäº¤'}</small></td>
            <td>
              <button class="btn btn-sm btn-primary ${rec.status !== 'Submitted' ? 'disabled' : ''}" 
                      onclick="generatePdf('${rec.uniqueId}', this)"
                      ${rec.status !== 'Submitted' ? 'disabled' : ''}>
                <i class="bi bi-file-earmark-pdf"></i> PDF
              </button>
            </td>
          </tr>`
        ).join('');
      }
      document.getElementById('records-loading').classList.add('d-none');
      document.getElementById('records-table-container').classList.remove('d-none');
    })
    .withFailureHandler(err => {
      document.getElementById('records-loading').innerHTML = `<p class="text-danger text-center">è¼‰å…¥å¤±æ•—ï¼š${err.message}</p>`;
    })
    .getRecords();
}

function generatePdf(uniqueId, btn) {
  if (btn.classList.contains('disabled')) return;
  
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ç”¢è£½ä¸­...';
  btn.disabled = true;

  google.script.run
    .withSuccessHandler(response => {
      if (response.success) {
        window.open(response.url, '_blank');
        if (response.message) {
          alert(`âœ… ${response.message}`);
        }
        loadRecords();
      } else {
        alert(`âŒ ç”¢ç”Ÿå¤±æ•—ï¼š${response.message}`);
      }
      btn.innerHTML = originalText;
      btn.disabled = false;
    })
    .withFailureHandler(err => {
      alert(`âŒ ç³»çµ±éŒ¯èª¤ï¼š${err.message}`);
      btn.innerHTML = originalText;
      btn.disabled = false;
    })
    .generatePdf(uniqueId);
}
</script>

</body>
</html>